services:
  timescaledb:
    image: timescale/timescaledb-ha:pg14-latest
    container_name: trader_timescaledb
    environment:
      - POSTGRES_PASSWORD=your_secure_password
    ports:
      - "5432:5432"
    volumes:
      -./timescaledb_data:/var/lib/postgresql/data
    healthcheck:
      # --- THIS IS THE CORRECTED LINE ---
      # We are changing the 'test' value from a list to a single string
      # to match what your Docker version is expecting.
      test: "pg_isready -U postgres -h localhost"
      interval: 5s
      timeout: 5s
      retries: 5

  trader_app:
    container_name: trader_app
    build: .
    command: python main.py
    restart: on-failure
    volumes:
      -.:/app
    environment:
      - KALSHI_API_KEY_ID=${KALSHI_API_KEY_ID}
      - KALSHI_PRIVATE_KEY_PATH=${KALSHI_PRIVATE_KEY_PATH}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - SERPER_API_KEY=${SERPER_API_KEY}
    depends_on:
      timescaledb:
        condition: service_healthy
